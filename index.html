<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ£ ìì£¼ê°€ëŠ” í•­êµ¬ ì§€ë„ Â· ì„ ì‚¬ ë…¸íŠ¸</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --ink:#eaf2f6;           /* ê¸€ì(ì•„ì´ë³´ë¦¬) */
      --muted:rgba(234,242,246,.72);
      --line:rgba(255,255,255,.18);
      --glass:rgba(20,30,36,.42);     /* ìœ ë¦¬ íŒ¨ë„ */
      --glass2:rgba(20,30,36,.28);
      --accent:#2fd3c6;        /* ì²­ë¡ í¬ì¸íŠ¸ */
      --accent2:#7bd0ff;       /* ë³´ì¡° í¬ì¸íŠ¸ */
      --danger:#ff6b6b;
      --shadow: 0 18px 44px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Noto Sans KR",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 480px at 20% 0%, rgba(47,211,198,.20), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(123,208,255,.18), transparent 55%),
        linear-gradient(180deg, #0b1217 0%, #0a0f14 100%);
    }

    header{
      position: sticky; top:0; z-index: 50;
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(8,12,16,.55);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .title{ font-weight:900; letter-spacing:-.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .wrap{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      height: calc(100vh - 58px);
    }

    /* Map ì˜ì—­ */
    #map{
      width:100%;
      height:100%;
      position:relative;
      overflow:hidden;
    }
    /* ì§€ë„ ìœ„ì— â€œí•´ë¬´â€ ëŠë‚Œ ì˜¤ë²„ë ˆì´ */
    .fog{
      pointer-events:none;
      position:absolute; inset:0;
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 30%, rgba(255,255,255,.08), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.22));
      mix-blend-mode: screen;
      opacity:.55;
      z-index: 400;
    }
    .map-vignette{
      pointer-events:none;
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 800px at 50% 50%, transparent 55%, rgba(0,0,0,.45) 100%);
      opacity:.55;
      z-index: 401;
    }

    aside{
      border-left:1px solid var(--line);
      padding:14px;
      overflow:auto;
      background: linear-gradient(180deg, rgba(8,12,16,.35), rgba(8,12,16,.65));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      box-shadow: var(--shadow);
      padding:12px;
      margin:10px 0;
    }
    .card.soft{
      background: var(--glass2);
      box-shadow: 0 12px 32px rgba(0,0,0,.22);
    }

    .muted{ color:var(--muted); font-size:13px; }
    .small{ color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .sep{ height:1px; background: var(--line); border:0; margin:10px 0; }

    .btn{
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      transition: .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{
      border-color: rgba(47,211,198,.35);
      background: rgba(47,211,198,.14);
      color: var(--ink);
    }
    .btn.primary:hover{ background: rgba(47,211,198,.18); }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
    }
    .btn.danger:hover{ background: rgba(255,107,107,.16); }

    .btn.tiny{ padding:8px 10px; border-radius:12px; }
    h2{ margin:0 0 6px; font-size:16px; letter-spacing:-.3px; }
    h3{ margin:0 0 8px; font-size:14px; letter-spacing:-.2px; }

    .sticky-tools{
      position: sticky; top: 0;
      padding: 8px 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(8,12,16,.65), rgba(8,12,16,0));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .ship{
      display:grid; gap:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
    }
    .ship .top{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .ship .name{ font-weight:900; }
    .ship .meta{ color:var(--muted); font-size:12px; margin-top:3px; }
    .ship a{ color: var(--accent2); text-decoration:none; font-weight:900; }
    .ship a:hover{ text-decoration:underline; }

    .tag{
      display:inline-flex; align-items:center;
      padding:4px 10px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      font-size:12px;
      color:rgba(234,242,246,.85);
      background: rgba(255,255,255,.06);
    }

    .fav{
      cursor:pointer; user-select:none;
      font-size:18px; line-height:1;
      padding:2px 6px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .fav.on{
      border-color: rgba(47,211,198,.45);
      background: rgba(47,211,198,.16);
    }

    textarea, input, select{
      width:100%;
      border:1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      padding:10px;
      font:inherit;
      color: var(--ink);
      background: rgba(0,0,0,.18);
    }
    textarea{ min-height:44px; resize:vertical; }
    textarea:focus, input:focus, select:focus{
      outline:none;
      border-color: rgba(47,211,198,.55);
      box-shadow: 0 0 0 4px rgba(47,211,198,.16);
    }

    .checks{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .checks label{ display:flex; gap:6px; align-items:center; font-size:13px; color:var(--muted); }

    .editbox{
      border:1px dashed rgba(47,211,198,.35);
      border-radius: 16px;
      padding:10px;
      background: rgba(47,211,198,.06);
    }

    /* Leaflet íˆ´íŒ/ì»¨íŠ¸ë¡¤ í†¤ ë‹¤ìš´ */
    .leaflet-control-zoom a{
      background: rgba(20,30,36,.55) !important;
      color: var(--ink) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      backdrop-filter: blur(10px);
    }
    .leaflet-tooltip{
      background: rgba(20,30,36,.72);
      border:1px solid rgba(255,255,255,.18);
      color: var(--ink);
      border-radius: 12px;
      padding: 6px 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      aside{ border-left:none; border-top:1px solid var(--line); height:44vh; }
      #map{ height:56vh; }
    }
  
    /* ===== ëª¨ë°”ì¼(íŠ¹íˆ iOS) ìŠ¤í¬ë¡¤ ì•ˆì •í™” íŒ¨ì¹˜ ===== */
    html, body { height: 100%; }
    body { overflow: hidden; }

    .wrap{
      /* ëª¨ë°”ì¼ ì£¼ì†Œì°½/íˆ´ë°” ë³€ë™ì„ ë°˜ì˜í•˜ëŠ” dvh ì‚¬ìš© */
      height: calc(100dvh - 58px);
      min-height: 0;
    }
    #map, aside{ min-height: 0; }

    aside{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      touch-action: pan-y;
    }

    @media (max-width: 980px){
      /* iOSì—ì„œ overflow ì»¨í…Œì´ë„ˆ ì•ˆ stickyê°€ ìŠ¤í¬ë¡¤ì„ ë°©í•´í•˜ëŠ” ê²½ìš°ê°€ ìˆì–´ ëª¨ë°”ì¼ì—ì„œëŠ” í•´ì œ */
      .sticky-tools{ position: static; }
      .wrap{ height: calc(100dvh - 58px); }
      #map{ height: 56dvh; }
      aside{ height: calc(44dvh - env(safe-area-inset-bottom)); }
    }

  </style>
</head>

<body>
<header>
  <div>
    <div class="title">ğŸŒ«ï¸ ìì£¼ê°€ëŠ” í•­êµ¬ ì§€ë„ Â· ì„ ì‚¬ ë…¸íŠ¸</div>
    <div class="sub">í•­êµ¬(âš“) í´ë¦­ â†’ ì„ ì‚¬ ëª©ë¡ / í¸ì§‘Â·ì‚­ì œ / ì¦ê²¨ì°¾ê¸°â­ / íƒœê·¸í•„í„° / í•œì¤„í‰</div>
  </div>
  <div class="row">
    <button class="btn danger" id="btnResetAll" title="ì €ì¥ ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”">ì „ì²´ ì´ˆê¸°í™”</button>
  </div>
</header>

<div class="wrap">
  <div id="map">
    <div class="fog"></div>
    <div class="map-vignette"></div>
  </div>

  <aside id="panel">
    <div class="card">
      <div class="muted">ì§€ë„ì—ì„œ í•­êµ¬ ë§ˆì»¤(âš“)ë¥¼ ëˆ„ë¥´ë©´ ì„ ì‚¬ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤.</div>
      <hr class="sep">
      <div class="small">ì €ì¥ ìœ„ì¹˜: ì´ ë¸Œë¼ìš°ì €(localStorage). ë‹¤ë¥¸ ê¸°ê¸°/ë¸Œë¼ìš°ì €ë¡œ ì˜®ê¸°ë ¤ë©´ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ ë¶™ì´ë©´ ë©ë‹ˆë‹¤.</div>
    </div>
  </aside>
</div>

<script>
  // íƒœê·¸(ìš”ì²­ì‚¬í•­)
  const TAGS = ["ì£¼ê¾¸ë¯¸","ê°‘ì˜¤ì§•ì–´","ë¬¸ì–´","ê´‘ì–´","ì°¸ë”","ë°±ì¡°ê¸°"];


  // í•­êµ¬(ì¢Œí‘œ í¬í•¨)
  const PORTS = [
    { id:"ocheon", name:"ì˜¤ì²œí•­", region:"ì¶©ë‚¨ ë³´ë ¹", lat:36.439312581, lng:126.5207654562 },
    { id:"mageompo", name:"ë§ˆê²€í¬í•­", region:"ì¶©ë‚¨ íƒœì•ˆ", lat:36.619986, lng:126.287276 },
    { id:"yeongmok", name:"ì˜ëª©í•­", region:"ì¶©ë‚¨ íƒœì•ˆ(ê³ ë‚¨ë©´)", lat:36.398959, lng:126.426825 },
    { id:"bieung", name:"ë¹„ì‘í•­", region:"ì „ë¶ êµ°ì‚°", lat:35.938583, lng:126.531205 },
    { id:"daecheon", name:"ëŒ€ì²œí•­", region:"ì¶©ë‚¨ ë³´ë ¹", lat:36.327479, lng:126.509662 },
    { id:"muchangpo", name:"ë¬´ì°½í¬í•­", region:"ì¶©ë‚¨ ë³´ë ¹", lat:36.248616, lng:126.536757 },
    { id:"incheon-yeonan", name:"ì¸ì²œ ì—°ì•ˆë¶€ë‘", region:"ì¸ì²œ ì¤‘êµ¬", lat:37.455552117, lng:126.6018306996 },
    { id:"gumae", name:"êµ¬ë§¤í•­", region:"ì¶©ë‚¨ íƒœì•ˆ(ê³ ë‚¨ë©´)", lat:36.424932, lng:126.432031 },
    { id:"namdang", name:"ë‚¨ë‹¹í•­", region:"ì¶©ë‚¨ í™ì„±", lat:36.5359, lng:126.4664 },
    { id:"hongwon", name:"í™ì›í•­", region:"ì¶©ë‚¨ ì„œì²œ", lat:36.157929, lng:126.500136 },
    { id:"nokdong", name:"ë…¹ë™í•­", region:"ì „ë‚¨ ê³ í¥", lat:34.526555, lng:127.131535 }
  ];

  function ship(id, name, phone, url, tags, favorite, review){
    return { id, name, phone, url, tags: tags || [], favorite: !!favorite, review: review || "" };
  }

  // ê¸°ë³¸ ì„ ì‚¬(ì˜ˆì‹œ)
  const DEFAULT_SHIPS_BY_PORT = {
    "ocheon": [
      ship("base-ocheon-1", "ì˜¤ì²œ â—‹â—‹í˜¸", "010-0000-0000", "https://example.com", ["ì£¼ê¾¸ë¯¸","ê´‘ì–´"], false, ""),
      ship("base-ocheon-2", "ì˜¤ì²œ â–³â–³í˜¸", "010-1111-1111", "https://example.com", ["ì£¼ê¾¸ë¯¸"], false, "")
    ],
    "daecheon": [
      ship("base-daecheon-1", "ëŒ€ì²œ â—‹â—‹í˜¸", "010-5555-5555", "https://example.com", ["ì£¼ê¾¸ë¯¸"], false, ""),
      ship("base-daecheon-2", "ëŒ€ì²œ â–³â–³í˜¸", "010-6666-6666", "https://example.com", ["ê´‘ì–´"], false, "")
    ],
    "mageompo": [],
    "yeongmok": [],
    "bieung": [],
    "muchangpo": [],
    "incheon-yeonan": [],
    "gumae": [],
    "namdang": [],
    "hongwon": [],
  };

  // ì €ì¥(ê¸°ë³¸ë„ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•˜ê²Œ í†µí•© ì €ì¥)
  const LS_SHIPS = "fishing_all_ships_v1";
  function safeParse(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
  function loadAllShips(){ const raw = localStorage.getItem(LS_SHIPS); return raw ? safeParse(raw, null) : null; }
  function saveAllShips(obj){ localStorage.setItem(LS_SHIPS, JSON.stringify(obj)); }

  function ensureInitialized(){
    const existing = loadAllShips();
    if (existing) return;
    const init = {};
    PORTS.forEach(p => { init[p.id] = (DEFAULT_SHIPS_BY_PORT[p.id] || []); });
    saveAllShips(init);
  }
  function getShips(portId){
    ensureInitialized();
    const all = loadAllShips() || {};
    return (all[portId] || []);
  }
  function setShips(portId, ships){
    ensureInitialized();
    const all = loadAllShips() || {};
    all[portId] = ships;
    saveAllShips(all);
  }
  function resetAll(){ localStorage.removeItem(LS_SHIPS); }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function openNaverSearch(q){ window.open(`https://map.naver.com/v5/search/${encodeURIComponent(q)}`, "_blank", "noopener"); }
  function openKakaoSearch(q){ window.open(`https://map.kakao.com/link/search/${encodeURIComponent(q)}`, "_blank", "noopener"); }

  function cryptoRandomId(){
    const a = new Uint32Array(2);
    crypto.getRandomValues(a);
    return (a[0].toString(16) + a[1].toString(16));
  }

  function normalizeTags(tags){
    const set = new Set((tags || []).filter(t => TAGS.includes(t)));
    return Array.from(set);
  }

  const panel = document.getElementById("panel");
  let currentPort = null;
  let currentFilter = "ì „ì²´";

  function sortShips(ships){
    return [...ships].sort((a,b) => {
      const fa = a.favorite ? 1 : 0;
      const fb = b.favorite ? 1 : 0;
      if (fa !== fb) return fb - fa;
      return String(a.name||"").localeCompare(String(b.name||""), "ko");
    });
  }
  function applyFilter(ships){
    if (currentFilter === "ì „ì²´") return ships;
    return ships.filter(s => (s.tags || []).includes(currentFilter));
  }
  function cssEscape(s){ return String(s).replaceAll('"','\\"'); }

  function renderTagChecks(prefix, selectedTags){
    const sel = new Set(selectedTags || []);
    return TAGS.map(t => {
      const id = `${prefix}-${t}`;
      return `<label><input type="checkbox" id="${id}" ${sel.has(t)?"checked":""}/> ${t}</label>`;
    }).join("");
  }

  function renderPort(port){
    currentPort = port;

    const shipsRaw = getShips(port.id);
    const shipsFiltered = applyFilter(sortShips(shipsRaw));

    panel.innerHTML = `
      <div class="sticky-tools">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <h2 style="margin:0;">${escapeHtml(port.name)}</h2>
              <div class="muted">${escapeHtml(port.region)} Â· ì„ ì‚¬ ${shipsRaw.length}ê°œ</div>
            </div>
            <div class="row">
              <button class="btn tiny" id="btnNaver">ë„¤ì´ë²„ì§€ë„</button>
              <button class="btn tiny" id="btnKakao">ì¹´ì¹´ì˜¤ë§µ</button>
            </div>
          </div>

          <hr class="sep">

          <div class="row" style="justify-content:space-between;">
            <div style="flex:1; min-width:220px;">
              <label class="small" for="filterSel" style="display:block; margin-bottom:6px;">ğŸ¯ ì˜¤ëŠ˜ ëª©í‘œ(í•„í„°)</label>
              <select id="filterSel">
                <option ${currentFilter==="ì „ì²´"?"selected":""}>ì „ì²´</option>
                ${TAGS.map(t => `<option ${currentFilter===t?"selected":""}>${t}</option>`).join("")}
              </select>
            </div>
            <div style="min-width:180px;">
              <label class="small" style="display:block; margin-bottom:6px;">ğŸ“Œ ì •ë ¬</label>
              <div class="small">ì¦ê²¨ì°¾ê¸°â­ê°€ í•­ìƒ ìœ„ë¡œ</div>
            </div>
          </div>

          <hr class="sep">

          <h3>â• ì„ ì‚¬ ì¶”ê°€</h3>
          <div class="row">
            <div style="flex:1; min-width:160px;">
              <input id="addName" placeholder="ì„ ì‚¬/ë°° ì´ë¦„ (ì˜ˆ: â—‹â—‹í˜¸)" />
            </div>
            <div style="flex:1; min-width:160px;">
              <input id="addPhone" placeholder="ì „í™” (ì˜ˆ: 010-1234-5678)" />
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div style="flex:1; min-width:220px;">
              <input id="addUrl" placeholder="ì˜ˆì•½/ì •ë³´ ë§í¬ (ì„ íƒ)" />
            </div>
            <button class="btn primary" id="btnAddShip">ì¶”ê°€</button>
          </div>

          <div class="checks" style="margin-top:8px;">
            <span class="small">íƒœê·¸:</span>
            ${renderTagChecks("addTag", [])}
            <span class="small">(í•„í„°ì— ì‚¬ìš©)</span>
          </div>

          <div class="small" style="margin-top:8px;">ì¶”ê°€/í¸ì§‘/ì‚­ì œ/ì¦ê²¨ì°¾ê¸°/í•œì¤„í‰ì€ ì´ ê¸°ê¸° ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="card soft">
        <h3 style="margin-bottom:10px;">ğŸš¤ ì„ ì‚¬ ëª©ë¡</h3>
        <div id="shipList" style="display:grid; gap:10px;"></div>
        ${shipsFiltered.length===0 ? `<div class="muted" style="margin-top:10px;">í•„í„° ì¡°ê±´ì— ë§ëŠ” ì„ ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>` : ``}
      </div>
    `;

    panel.querySelector("#btnNaver").addEventListener("click", () => openNaverSearch(port.name));
    panel.querySelector("#btnKakao").addEventListener("click", () => openKakaoSearch(port.name));

    panel.querySelector("#filterSel").addEventListener("change", (e) => {
      currentFilter = e.target.value;
      renderPort(port);
    });

    panel.querySelector("#btnAddShip").addEventListener("click", () => {
      const name = (panel.querySelector("#addName").value || "").trim();
      const phone = (panel.querySelector("#addPhone").value || "").trim();
      const url = (panel.querySelector("#addUrl").value || "").trim();
      if (!name){ alert("ì„ ì‚¬/ë°° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

      const tags = [];
      TAGS.forEach(t => {
        const id = `addTag-${t}`;
        const el = panel.querySelector(`#${cssEscape(id)}`);
        if (el && el.checked) tags.push(t);
      });

      const ships = getShips(port.id);
      ships.unshift(ship("user-" + cryptoRandomId(), name, phone, url, normalizeTags(tags), false, ""));
      setShips(port.id, ships);
      renderPort(port);
    });

    renderShipList(port);
  }

  function renderShipList(port){
    const host = panel.querySelector("#shipList");
    if (!host) return;

    const shipsAll = getShips(port.id);
    const ships = applyFilter(sortShips(shipsAll));

    host.innerHTML = ships.map(s => {
      const link = s.url ? ` Â· <a href="${s.url}" target="_blank" rel="noopener">ì˜ˆì•½/ì •ë³´ ë§í¬</a>` : "";
      const tags = (s.tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join(" ");

      return `
        <div class="ship" data-id="${escapeHtml(s.id)}">
          <div class="top">
            <div>
              <div class="name">${escapeHtml(s.name)}</div>
              <div class="meta">â˜ ${escapeHtml(s.phone || "-")}${link}</div>
              <div class="row" style="margin-top:8px;">${tags || `<span class="tag">íƒœê·¸ ì—†ìŒ</span>`}</div>
            </div>

            <div class="row" style="align-items:flex-start;">
              <div class="fav ${s.favorite ? "on" : ""}" title="ì¦ê²¨ì°¾ê¸°" data-fav="${escapeHtml(s.id)}">${s.favorite ? "â­" : "â˜†"}</div>
              <button class="btn tiny" data-edit="${escapeHtml(s.id)}">í¸ì§‘</button>
              <button class="btn tiny danger" data-del="${escapeHtml(s.id)}">ì‚­ì œ</button>
            </div>
          </div>

          <div>
            <textarea maxlength="140" data-review="${escapeHtml(s.id)}"
              placeholder="í•œì¤„í‰(ì˜ˆ: ì¹œì ˆ/ì¶œí•­ ë¹ ë¦„/ìë¦¬ì¶”ì²¨ ê³µì •/í¬ì¸íŠ¸ ì¢‹ìŒ ë“±)">${escapeHtml(s.review || "")}</textarea>
            <div class="small">ì €ì¥: ìë™</div>
          </div>

          <div class="editbox" style="display:none;" data-editbox="${escapeHtml(s.id)}">
            <div class="row">
              <div style="flex:1; min-width:160px;">
                <input data-e-name="${escapeHtml(s.id)}" placeholder="ì´ë¦„" value="${escapeHtml(s.name || "")}" />
              </div>
              <div style="flex:1; min-width:160px;">
                <input data-e-phone="${escapeHtml(s.id)}" placeholder="ì „í™”" value="${escapeHtml(s.phone || "")}" />
              </div>
            </div>
            <div class="row" style="margin-top:8px;">
              <div style="flex:1; min-width:220px;">
                <input data-e-url="${escapeHtml(s.id)}" placeholder="ì˜ˆì•½/ì •ë³´ ë§í¬" value="${escapeHtml(s.url || "")}" />
              </div>
            </div>

            <div class="checks" style="margin-top:10px;">
              <span class="small">íƒœê·¸:</span>
              ${TAGS.map(t => `
                <label>
                  <input type="checkbox" data-e-id="${escapeHtml(s.id)}" data-e-tag="${escapeHtml(t)}" ${s.tags?.includes(t) ? "checked":""}/>
                  ${escapeHtml(t)}
                </label>
              `).join("")}
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary tiny" data-save="${escapeHtml(s.id)}">ì €ì¥</button>
              <button class="btn tiny" data-cancel="${escapeHtml(s.id)}">ì·¨ì†Œ</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    // ì¦ê²¨ì°¾ê¸°
    host.querySelectorAll("[data-fav]").forEach(el => {
      el.addEventListener("click", () => {
        const id = el.getAttribute("data-fav");
        const ships = getShips(port.id);
        const idx = ships.findIndex(x => x.id === id);
        if (idx < 0) return;
        ships[idx].favorite = !ships[idx].favorite;
        setShips(port.id, ships);
        renderPort(port);
      });
    });

    // í•œì¤„í‰ ìë™ ì €ì¥
    host.querySelectorAll("textarea[data-review]").forEach(t => {
      t.addEventListener("input", () => {
        const id = t.getAttribute("data-review");
        const ships = getShips(port.id);
        const idx = ships.findIndex(x => x.id === id);
        if (idx < 0) return;
        ships[idx].review = (t.value || "").slice(0, 140);
        setShips(port.id, ships);
      });
    });

    // ì‚­ì œ
    host.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del");
        const ok = confirm("ì´ ì„ ì‚¬ë¥¼ ì‚­ì œí• ê¹Œìš”? (ì¦ê²¨ì°¾ê¸°/í•œì¤„í‰ í¬í•¨)");
        if (!ok) return;
        const ships = getShips(port.id).filter(x => x.id !== id);
        setShips(port.id, ships);
        renderPort(port);
      });
    });

    // í¸ì§‘ í† ê¸€
    host.querySelectorAll("button[data-edit]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const box = host.querySelector(`[data-editbox="${cssEscape(id)}"]`);
        if (!box) return;
        const isOpen = box.style.display !== "none";
        host.querySelectorAll("[data-editbox]").forEach(b => b.style.display = "none");
        box.style.display = isOpen ? "none" : "block";
      });
    });

    host.querySelectorAll("button[data-cancel]").forEach(btn => {
      btn.addEventListener("click", () => renderPort(port));
    });

    // í¸ì§‘ ì €ì¥
    host.querySelectorAll("button[data-save]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-save");
        const ships = getShips(port.id);
        const idx = ships.findIndex(x => x.id === id);
        if (idx < 0) return;

        const name = host.querySelector(`[data-e-name="${cssEscape(id)}"]`)?.value?.trim() || "";
        const phone = host.querySelector(`[data-e-phone="${cssEscape(id)}"]`)?.value?.trim() || "";
        const url = host.querySelector(`[data-e-url="${cssEscape(id)}"]`)?.value?.trim() || "";
        if (!name){ alert("ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ì–´ìš”."); return; }

        const tags = [];
        host.querySelectorAll(`input[type="checkbox"][data-e-id="${cssEscape(id)}"]`).forEach(chk => {
          if (chk.checked) tags.push(chk.getAttribute("data-e-tag"));
        });

        ships[idx].name = name;
        ships[idx].phone = phone;
        ships[idx].url = url;
        ships[idx].tags = normalizeTags(tags);

        setShips(port.id, ships);
        renderPort(port);
      });
    });
  }

  // ì§€ë„ ìƒì„±
const map = L.map("map", { zoomControl: true }).setView([36.0, 127.4], 7);

// 1) ì¼ë°˜ ì§€ë„(ë¼ë²¨ ì˜ ë³´ì„) - OSM
const normalLayer = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }
);

// 2) ìœ„ì„± ì§€ë„(í˜„ì¥ê°) - Esri World Imagery
const satelliteLayer = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    maxZoom: 18,
    attribution: "Tiles Â© Esri"
  }
);

// ê¸°ë³¸ìœ¼ë¡œ ìœ„ì„± ì§€ë„ ì¼œê¸°(ì›í•˜ë©´ normalLayerë¡œ ë°”ê¿”ë„ ë¨)
satelliteLayer.addTo(map);

// ë ˆì´ì–´ ì „í™˜ ì»¨íŠ¸ë¡¤(ì˜¤ë¥¸ìª½ ìœ„)
const baseMaps = {
  "ğŸ›°ï¸ ìœ„ì„±": satelliteLayer,
  "ğŸ—ºï¸ ì¼ë°˜": normalLayer
};
L.control.layers(baseMaps, null, { position: "topright" }).addTo(map);


  // í•­êµ¬ ë§ˆì»¤: âš“
  const harborIcon = L.divIcon({ html: "âš“", className: "", iconSize: [28, 28] });

  PORTS.forEach(port => {
    const marker = L.marker([port.lat, port.lng], { icon: harborIcon }).addTo(map);
    marker.bindTooltip(port.name, { direction:"top", opacity: 0.95 });
    marker.on("click", () => renderPort(port));
  });

  document.getElementById("btnResetAll").addEventListener("click", () => {
    const ok = confirm("ì •ë§ ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ì„ ì‚¬ ëª©ë¡/ì¦ê²¨ì°¾ê¸°/íƒœê·¸/í•œì¤„í‰ ëª¨ë‘ ì‚­ì œ)");
    if (!ok) return;
    resetAll();
    alert("ì´ˆê¸°í™” ì™„ë£Œ. ê¸°ë³¸ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.");
    currentPort = null;
    currentFilter = "ì „ì²´";
    panel.innerHTML = `
      <div class="card">
        <div class="muted">ì§€ë„ì—ì„œ í•­êµ¬ ë§ˆì»¤(âš“)ë¥¼ ëˆ„ë¥´ë©´ ì„ ì‚¬ ëª©ë¡ì´ ëœ¹ë‹ˆë‹¤.</div>
        <hr class="sep">
        <div class="small">ì €ì¥ ìœ„ì¹˜: ì´ ë¸Œë¼ìš°ì €(localStorage).</div>
      </div>
    `;
    ensureInitialized();
  });
</script>
</body>
</html>
