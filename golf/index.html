<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>â›³ Golf Log Â· ë¼ìš´ë“œ ë…¸íŠ¸</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --ink:#eaf2f6;
      --muted:rgba(234,242,246,.72);
      --line:rgba(255,255,255,.18);
      --glass:rgba(20,30,36,.42);
      --glass2:rgba(20,30,36,.28);
      --accent:#2fd3c6;
      --accent2:#7bd0ff;
      --danger:#ff6b6b;
      --warn:#ffd43b;
      --shadow: 0 18px 44px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Noto Sans KR",sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 480px at 20% 0%, rgba(47,211,198,.20), transparent 55%),
        radial-gradient(900px 420px at 90% 10%, rgba(123,208,255,.18), transparent 55%),
        linear-gradient(180deg, #0b1217 0%, #0a0f14 100%);
    }
    header{
      position: sticky; top:0; z-index:50;
      padding:12px 16px;
      border-bottom:1px solid var(--line);
      background: rgba(8,12,16,.55);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      display:flex; justify-content:space-between; gap:12px; align-items:center;
    }
    .title{ font-weight:900; letter-spacing:-.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:2px; }

    .wrap{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      height: calc(100dvh - 58px);
      min-height:0;
    }

    #map{
      width:100%;
      height:100%;
      position:relative;
      overflow:hidden;
      min-height:0;
    }
    .fog{
      pointer-events:none;
      position:absolute; inset:0;
      background:
        radial-gradient(900px 420px at 30% 20%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(900px 520px at 70% 30%, rgba(255,255,255,.08), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.22));
      mix-blend-mode: screen;
      opacity:.45;
      z-index: 400;
    }
    .map-vignette{
      pointer-events:none;
      position:absolute; inset:0;
      background:
        radial-gradient(1200px 800px at 50% 50%, transparent 55%, rgba(0,0,0,.45) 100%);
      opacity:.55;
      z-index: 401;
    }

    aside{
      border-left:1px solid var(--line);
      padding:14px;
      overflow-y:auto;
      min-height:0;
      background: linear-gradient(180deg, rgba(8,12,16,.35), rgba(8,12,16,.65));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--glass);
      backdrop-filter: blur(14px) saturate(120%);
      -webkit-backdrop-filter: blur(14px) saturate(120%);
      box-shadow: var(--shadow);
      padding:12px;
      margin:10px 0;
    }
    .card.soft{
      background: var(--glass2);
      box-shadow: 0 12px 32px rgba(0,0,0,.22);
    }

    .muted{ color:var(--muted); font-size:13px; }
    .small{ color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .sep{ height:1px; background: var(--line); border:0; margin:10px 0; }

    .btn{
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
      color:var(--ink);
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      transition: .12s ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    .btn.primary{
      border-color: rgba(47,211,198,.35);
      background: rgba(47,211,198,.14);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.12);
    }
    .btn.warn{
      border-color: rgba(255,212,59,.35);
      background: rgba(255,212,59,.12);
    }
    .btn.tiny{ padding:8px 10px; border-radius:12px; }
    .btn.active{
      border-color: rgba(47,211,198,.45);
      background: rgba(47,211,198,.18);
    }

    input, select, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.20);
      border-radius: 14px;
      padding:10px;
      font:inherit;
      color: var(--ink);
      background: rgba(0,0,0,.18);
    }
    textarea{ min-height: 64px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color: rgba(47,211,198,.55);
      box-shadow: 0 0 0 4px rgba(47,211,198,.16);
    }

    .tag{
      display:inline-flex; align-items:center;
      padding:4px 10px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      font-size:12px;
      color:rgba(234,242,246,.85);
      background: rgba(255,255,255,.06);
    }

    .fav{
      cursor:pointer; user-select:none;
      font-size:18px; line-height:1;
      padding:2px 6px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }
    .fav.on{
      border-color: rgba(47,211,198,.45);
      background: rgba(47,211,198,.16);
    }

    /* ë§ˆì»¤(â›³ + ë°©ë¬¸íšŸìˆ˜ ë°°ì§€) */
    .golf-marker{
      position: relative;
      width: 30px;
      height: 30px;
      font-size: 22px;
      line-height: 30px;
      text-align: center;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
    }
    .golf-badge{
      position: absolute;
      top: -6px;
      right: -10px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      line-height: 18px;
      text-align: center;
      color: #001414;
      background: #2fd3c6;
      box-shadow: 0 0 0 2px rgba(0,0,0,.35),
                  0 4px 10px rgba(0,0,0,.45);
    }

    /* í™€ ì…ë ¥ í…Œì´ë¸” */
    .holes-wrap{
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.04);
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 920px; /* 18í™€ + í•©ê³„ */
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,.12);
      padding:8px;
      font-size: 12px;
      white-space: nowrap;
      vertical-align: middle;
    }
    th{
      text-align:left;
      font-weight: 900;
      color: rgba(234,242,246,.92);
      position: sticky;
      top: 0;
      background: rgba(20,30,36,.85);
      z-index: 2;
    }
    td input{
      padding:6px 8px;
      border-radius: 10px;
    }
    .me-badge{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(47,211,198,.35);
      background: rgba(47,211,198,.14);
      font-weight: 900;
      font-size: 12px;
      margin-left: 6px;
    }

    .sticky-tools{
      position: sticky; top: 0;
      padding: 8px 0;
      z-index: 10;
      background: linear-gradient(180deg, rgba(8,12,16,.80), rgba(8,12,16,0));
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .item{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      padding: 12px;
      margin-top: 10px;
    }

    .highlight-rain{
      border-color: rgba(255,212,59,.35) !important;
      background: rgba(255,212,59,.10) !important;
    }

    /* Leaflet glass controls */
    .leaflet-control-zoom a,
    .leaflet-control-layers{
      background: rgba(20,30,36,.55) !important;
      color: var(--ink) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      border-radius: 14px !important;
      box-shadow: 0 14px 32px rgba(0,0,0,.35) !important;
      backdrop-filter: blur(12px) saturate(120%);
      -webkit-backdrop-filter: blur(12px) saturate(120%);
    }
    .leaflet-control-layers label{ color: rgba(234,242,246,.95) !important; }
    .leaflet-control-layers-toggle{ filter: invert(1) brightness(1.2); }
    .leaflet-tooltip{
      background: rgba(20,30,36,.72);
      border:1px solid rgba(255,255,255,.18);
      color: var(--ink);
      border-radius: 12px;
      padding: 6px 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    /* ëª¨ë°”ì¼ ì•ˆì •í™” */
    html, body { height: 100%; }
    body { overflow: hidden; }

    @media (max-width: 980px){
      .sticky-tools{ position: static; }
      .wrap{ grid-template-columns:1fr; height: calc(100dvh - 58px); }
      #map{ height: 56dvh; }
      aside{ height: calc(44dvh - env(safe-area-inset-bottom)); border-left:none; border-top:1px solid var(--line); }
    }
  </style>
</head>

<body>
<header>
  <div>
    <div class="title">ğŸŒ«ï¸ ê³¨í”„ì¥ ì§€ë„ Â· ë¼ìš´ë“œ ë…¸íŠ¸</div>
    <div class="sub">â›³ ë§ˆì»¤ ìˆ«ì = ë°©ë¬¸íšŸìˆ˜ Â· ë¼ìš´ë“œ ìƒì„¸(18í™€/ë™ë°˜ì/ë©”ëª¨) Â· í†µê³„</div>
  </div>
  <div class="row">
    <button class="btn danger" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”</button>
  </div>
</header>

<div class="wrap">
  <div id="map">
    <div class="fog"></div>
    <div class="map-vignette"></div>
  </div>
  <aside id="panel"></aside>
</div>

<script>
  /**********************
   * Storage keys
   **********************/
  const LS_COURSES = "golf_courses_v2"; // [{id,name,region,lat,lng,homepage,favorite,tags[]}]
  const LS_ROUNDS  = "golf_rounds_v2";  // { courseId: [ {id,date,teeTime,players:[{name,holes[18]}],comment} ] }
  const LS_CHECK   = "golf_checklist_v2"; // [{id,label,done,kind}]
  const LS_PREF    = "golf_prefs_v2";     // { checklistOpen, rainyMode, tagFilter }

  const TAGS = ["ê°€ì„±ë¹„","ë‚œì´ë„â†‘","ê·¸ë¦°ë¹ ë¦„","ë°”ëŒ","ì½”ìŠ¤ì¬ë°ŒìŒ","ì•¼ê°„","ìºë””êµ¿","ë·°ë§›ì§‘"];

  function safeParse(s, fallback){ try { return JSON.parse(s); } catch { return fallback; } }
  function cryptoRandomId(){
    const a = new Uint32Array(2);
    crypto.getRandomValues(a);
    return (a[0].toString(16) + a[1].toString(16));
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function normalizeTags(tags){
    const set = new Set((tags || []).filter(t => TAGS.includes(t)));
    return Array.from(set);
  }

  function loadCourses(){ return safeParse(localStorage.getItem(LS_COURSES) || "[]", []); }
  function saveCourses(list){ localStorage.setItem(LS_COURSES, JSON.stringify(list)); }

  function loadRounds(){ return safeParse(localStorage.getItem(LS_ROUNDS) || "{}", {}); }
  function saveRounds(obj){ localStorage.setItem(LS_ROUNDS, JSON.stringify(obj)); }

  function loadPrefs(){
    const p = safeParse(localStorage.getItem(LS_PREF) || "null", null);
    return p || { checklistOpen:false, rainyMode:false, tagFilter:"ì „ì²´", recentN:5 };
  }
  function savePrefs(p){ localStorage.setItem(LS_PREF, JSON.stringify(p)); }

  function loadChecklist(){
    const v = safeParse(localStorage.getItem(LS_CHECK) || "null", null);
    if (v) return v;
    const defaults = [
      { id:"c1", label:"í´ëŸ½/ê³¨í”„ë°±", done:false, kind:"base" },
      { id:"c2", label:"ê³¨í”„í™” / ì¥ê°‘(ì—¬ë¶„)", done:false, kind:"base" },
      { id:"c3", label:"ë³¼ / í‹° / ë³¼ë§ˆì»¤", done:false, kind:"base" },
      { id:"c4", label:"ê±°ë¦¬ì¸¡ì •ê¸° / ì¶©ì „", done:false, kind:"base" },
      { id:"c5", label:"ìš°ì‚° / ë ˆì¸ì›¨ì–´", done:false, kind:"rain" },
      { id:"c6", label:"íƒ€ì›”(ì—¬ë¶„) / ì¥ê°‘ ì—¬ë²Œ", done:false, kind:"rain" },
      { id:"c7", label:"ì„ í¬ë¦¼/ëª¨ì/ì„ ê¸€ë¼ìŠ¤", done:false, kind:"base" },
      { id:"c8", label:"ê°„ì‹/ë¬¼/ë³´ì˜¨", done:false, kind:"base" }
    ];
    localStorage.setItem(LS_CHECK, JSON.stringify(defaults));
    return defaults;
  }
  function saveChecklist(list){ localStorage.setItem(LS_CHECK, JSON.stringify(list)); }

  /**********************
   * Map
   **********************/
  const map = L.map("map", { zoomControl:true, tap:false }).setView([36.2, 127.7], 7);

  const normalLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19, attribution: "&copy; OpenStreetMap contributors"
  });
  const satelliteLayer = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom: 18, attribution: "Tiles Â© Esri" }
  );
  satelliteLayer.addTo(map);
  L.control.layers({ "ğŸ›°ï¸ ìœ„ì„±": satelliteLayer, "ğŸ—ºï¸ ì¼ë°˜": normalLayer }, null, { position:"topright" }).addTo(map);

  const courseMarkers = {}; // courseId -> marker
  function getVisitCount(courseId){
    const rounds = loadRounds();
    return (rounds[courseId] || []).length;
  }
  function createCourseIcon(visitCount){
    const badge = visitCount > 0 ? `<span class="golf-badge">${visitCount}</span>` : "";
    return L.divIcon({
      html: `<div class="golf-marker">â›³${badge}</div>`,
      className: "",
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });
  }
  function updateCourseMarker(course){
    const m = courseMarkers[course.id];
    if (!m) return;
    const cnt = getVisitCount(course.id);
    m.setIcon(createCourseIcon(cnt));
    m.unbindTooltip();
    m.bindTooltip(`${course.name} Â· ë°©ë¬¸ ${cnt}`, { direction:"top", opacity:0.95 });
  }
  function rebuildMarkers(){
    Object.values(courseMarkers).forEach(m => map.removeLayer(m));
    for (const k of Object.keys(courseMarkers)) delete courseMarkers[k];

    const courses = loadCourses();
    courses.forEach(c => {
      const cnt = getVisitCount(c.id);
      const marker = L.marker([c.lat, c.lng], { icon: createCourseIcon(cnt) }).addTo(map);
      marker.bindTooltip(`${c.name} Â· ë°©ë¬¸ ${cnt}`, { direction:"top", opacity:0.95 });
      marker.on("click", () => selectCourse(c.id, true));
      courseMarkers[c.id] = marker;
    });
  }

  /**********************
   * UI State
   **********************/
  const panel = document.getElementById("panel");
  let currentCourseId = null;

  let pickingCourseLocation = false;
  let pickedLatLng = null;

  let prefs = loadPrefs();

  // Round form draft
  let playersDraft = [{ name:"ë‚˜", holes:Array(18).fill("") }];
  let editRoundId = null;

  function sortCourses(list){
    return [...list].sort((a,b)=>{
      const fa = a.favorite ? 1 : 0;
      const fb = b.favorite ? 1 : 0;
      if (fa !== fb) return fb - fa;
      return String(a.name||"").localeCompare(String(b.name||""), "ko");
    });
  }
  function applyCourseFilter(list){
    if (prefs.tagFilter === "ì „ì²´") return list;
    return list.filter(c => (c.tags||[]).includes(prefs.tagFilter));
  }

  function selectCourse(courseId, panTo){
    currentCourseId = courseId;
    const c = loadCourses().find(x => x.id === courseId);
    if (c && panTo) map.setView([c.lat, c.lng], 12, { animate:true });
    render();
    if (c && panTo) courseMarkers[c.id]?.openTooltip();
  }

  function renderTagChecks(prefix, selected){
    const sel = new Set(selected || []);
    return TAGS.map(t => {
      const id = `${prefix}-${t}`;
      return `<label class="tag"><input type="checkbox" id="${id}" ${sel.has(t)?"checked":""} style="margin-right:6px;">${escapeHtml(t)}</label>`;
    }).join(" ");
  }

  /**********************
   * Stats
   **********************/
  function sumHoles(holes){
    // holes is array length 18, may include "".
    let sum = 0;
    let cnt = 0;
    for (const v of holes){
      const n = parseInt(v, 10);
      if (!Number.isNaN(n)) { sum += n; cnt++; }
    }
    return { sum, filled: cnt };
  }

  function getMeTotalFromRound(round){
    const me = (round.players || []).find(p => (p.name||"").trim() === "ë‚˜");
    if (!me) return null;
    const { sum, filled } = sumHoles(me.holes || []);
    // if not all holes filled, still allow partial but mark as null for averages unless full 18 filled
    return (filled === 18) ? sum : null;
  }

  function computeStatsForCourse(courseId){
    const roundsObj = loadRounds();
    const rounds = roundsObj[courseId] || [];
    const meTotals = rounds
      .map(r => ({ id:r.id, date:r.date, total:getMeTotalFromRound(r) }))
      .filter(x => x.total !== null);

    const avg = meTotals.length ? (meTotals.reduce((a,b)=>a+b.total,0) / meTotals.length) : null;
    return { count: rounds.length, meCount: meTotals.length, meAvg: avg, meTotals };
  }

  function computeOverallStats(){
    const roundsObj = loadRounds();
    const allRounds = Object.values(roundsObj).flat();
    const meTotals = allRounds
      .map(r => ({ date:r.date || "", total:getMeTotalFromRound(r), courseId: r.courseId || "" }))
      .filter(x => x.total !== null)
      .sort((a,b)=> String(b.date).localeCompare(String(a.date)));

    const avg = meTotals.length ? (meTotals.reduce((a,b)=>a+b.total,0) / meTotals.length) : null;
    const recent = meTotals.slice(0, prefs.recentN);
    const recentAvg = recent.length ? (recent.reduce((a,b)=>a+b.total,0) / recent.length) : null;
    return { meCount: meTotals.length, meAvg: avg, recentN: prefs.recentN, recentAvg };
  }

  /**********************
   * Checklist
   **********************/
  function renderChecklist(){
    const items = loadChecklist();
    const listHtml = items.map(i => {
      const cls = (prefs.rainyMode && i.kind === "rain") ? "highlight-rain" : "";
      return `
        <div class="row ${cls}" style="justify-content:space-between; gap:10px; margin:6px 0; padding:6px 8px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.03);">
          <label style="display:flex; gap:10px; align-items:center; color:rgba(234,242,246,.92);">
            <input type="checkbox" data-check="${i.id}" ${i.done ? "checked":""}>
            <span>${escapeHtml(i.label)}</span>
          </label>
        </div>
      `;
    }).join("");

    return `
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div style="font-weight:900;">âœ… ë¼ìš´ë”© ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
          <div class="row">
            <button class="btn tiny warn ${prefs.rainyMode ? "active":""}" id="btnRain">â˜” ë¹„ì˜¤ëŠ”ë‚ </button>
            <button class="btn tiny ${prefs.checklistOpen ? "active":""}" id="btnToggleChecklist">
              ${prefs.checklistOpen ? "ë‹«ê¸°" : "ì—´ê¸°"}
            </button>
          </div>
        </div>
        ${prefs.checklistOpen ? `
          <hr class="sep">
          ${listHtml}
          <div class="row" style="margin-top:10px;">
            <button class="btn tiny" id="btnChecklistReset">ì²´í¬ í•´ì œ</button>
          </div>
        ` : `<div class="small" style="margin-top:6px;">í•„ìš”í•  ë•Œë§Œ í¼ì³ì„œ ì“°ëŠ” ì‘ì€ íŒ¨ë„</div>`}
      </div>
    `;
  }

  /**********************
   * Courses list / Add course
   **********************/
  function renderCoursesList(){
    const courses = applyCourseFilter(sortCourses(loadCourses()));
    const overall = computeOverallStats();

    const statsLine = overall.meAvg !== null
      ? `ë‚˜ í‰ê·  ${overall.meAvg.toFixed(1)}íƒ€ Â· ìµœê·¼ ${overall.recentN}íšŒ ${overall.recentAvg?.toFixed(1) ?? "-"}íƒ€`
      : `ë‚˜ ìŠ¤ì½”ì–´(18í™€ ì™„ì„± ê¸°ë¡) ì—†ìŒ`;

    const html = courses.map(c => {
      const cnt = getVisitCount(c.id);
      const tags = (c.tags||[]).slice(0,4).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(" ");
      const active = (c.id === currentCourseId) ? "style='border-color: rgba(47,211,198,.45); background: rgba(47,211,198,.10);'" : "";
      return `
        <div class="item" ${active}>
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:900;">${escapeHtml(c.name)}</div>
              <div class="muted">${escapeHtml(c.region||"")} Â· ë°©ë¬¸ ${cnt}</div>
              <div class="row" style="margin-top:8px;">${tags || `<span class="tag">íƒœê·¸ ì—†ìŒ</span>`}</div>
            </div>
            <div class="row">
              <div class="fav ${c.favorite ? "on":""}" data-fav="${escapeHtml(c.id)}" title="ì¦ê²¨ì°¾ê¸°">${c.favorite ? "â­":"â˜†"}</div>
              <button class="btn tiny" data-open="${escapeHtml(c.id)}">ì—´ê¸°</button>
              <button class="btn tiny danger" data-del-course="${escapeHtml(c.id)}">ì‚­ì œ</button>
            </div>
          </div>
          ${c.homepage ? `<div class="small" style="margin-top:8px;">í™ˆí˜ì´ì§€: <a href="${c.homepage}" target="_blank" rel="noopener" style="color:var(--accent2); font-weight:900;">ì—´ê¸°</a></div>` : ``}
        </div>
      `;
    }).join("");

    return `
      <div class="card soft">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div style="font-weight:900;">â›³ ê³¨í”„ì¥</div>
            <div class="small">${statsLine}</div>
          </div>
          <div style="min-width: 190px;">
            <select id="tagFilter">
              <option ${prefs.tagFilter==="ì „ì²´"?"selected":""}>ì „ì²´</option>
              ${TAGS.map(t=>`<option ${prefs.tagFilter===t?"selected":""}>${escapeHtml(t)}</option>`).join("")}
            </select>
          </div>
        </div>
        <hr class="sep">
        ${html || `<div class="muted">ì•„ì§ ê³¨í”„ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</div>`}
      </div>
    `;
  }

  function renderAddCourse(){
    return `
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:900;">â• ê³¨í”„ì¥ ì¶”ê°€</div>
            <div class="small">â€œìœ„ì¹˜ ì°ê¸°â€ â†’ ì§€ë„ íƒ­ â†’ ì •ë³´ ì…ë ¥ â†’ ì¶”ê°€</div>
          </div>
          <button class="btn tiny primary ${pickingCourseLocation ? "active":""}" id="btnPickCourse">
            ${pickingCourseLocation ? "ìœ„ì¹˜ ì°ëŠ” ì¤‘â€¦" : "ìœ„ì¹˜ ì°ê¸°"}
          </button>
        </div>

        <hr class="sep">

        <div class="row">
          <div style="flex:1; min-width:160px;">
            <input id="addCourseName" placeholder="ê³¨í”„ì¥ ì´ë¦„" />
          </div>
          <div style="flex:1; min-width:160px;">
            <input id="addCourseRegion" placeholder="ì§€ì—­(ì˜ˆ: ì¶©ë‚¨ íƒœì•ˆ)" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div style="flex:1; min-width:220px;">
            <input id="addCourseHome" placeholder="ê³¨í”„ì¥ í™ˆí˜ì´ì§€(ì„ íƒ)" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <span class="small">íƒœê·¸:</span>
          <div class="row" style="gap:6px;">${renderTagChecks("addCourseTag", [])}</div>
        </div>

        <div class="row" style="margin-top:10px; justify-content:space-between;">
          <button class="btn primary" id="btnAddCourse">ì¶”ê°€</button>
          <div class="small" id="pickedCourseInfo">
            ${pickedLatLng ? `ğŸ“ ì„ íƒë¨: ${pickedLatLng.lat.toFixed(5)}, ${pickedLatLng.lng.toFixed(5)}` : "ğŸ“ ì•„ì§ ìœ„ì¹˜ê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}
          </div>
        </div>
      </div>
    `;
  }

  /**********************
   * Round detail
   **********************/
  function renderPlayersTable(){
    const headerHoles = Array.from({length:18}, (_,i)=>`<th>H${i+1}</th>`).join("");
    const rows = playersDraft.map((p, pi) => {
      const holes = (p.holes || Array(18).fill(""));
      const { sum, filled } = sumHoles(holes);
      const out = sumHoles(holes.slice(0,9));
      const inn = sumHoles(holes.slice(9,18));
      const isMe = (p.name || "").trim() === "ë‚˜";
      return `
        <tr>
          <td>
            <input data-pname="${pi}" value="${escapeHtml(p.name||"")}" placeholder="ì´ë¦„">
            ${isMe ? `<span class="me-badge">ME</span>` : ``}
          </td>
          ${holes.map((v, hi)=>`
            <td><input data-hole="${pi}:${hi}" value="${escapeHtml(v)}" placeholder="-" inputmode="numeric"></td>
          `).join("")}
          <td><b>${out.sum || 0}</b></td>
          <td><b>${inn.sum || 0}</b></td>
          <td><b>${filled===18 ? sum : (filled? sum+"*" : "-")}</b></td>
          <td><button class="btn tiny danger" data-pdel="${pi}">ì‚­ì œ</button></td>
        </tr>
      `;
    }).join("");

    return `
      <div class="holes-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:150px;">í”Œë ˆì´ì–´</th>
              ${headerHoles}
              <th>OUT</th>
              <th>IN</th>
              <th>TOT</th>
              <th>ì‚­ì œ</th>
            </tr>
          </thead>
          <tbody id="playersBody">
            ${rows}
          </tbody>
        </table>
      </div>
      <div class="small" style="margin-top:6px;">
        â€» TOT ì˜†ì— * í‘œì‹œëŠ” 18í™€ ë¯¸ì™„ì„±(ë¶€ë¶„ ì…ë ¥)ì…ë‹ˆë‹¤. í‰ê·  ê³„ì‚°ì—ëŠ” 18í™€ ì™„ì„± ê¸°ë¡ë§Œ ë°˜ì˜.
      </div>
    `;
  }

  function computeCourseStatsLine(courseId){
    const st = computeStatsForCourse(courseId);
    if (st.meAvg === null) return "ë‚˜ 18í™€ ì™„ì„± ê¸°ë¡ ì—†ìŒ";
    return `ë‚˜ í‰ê·  ${st.meAvg.toFixed(1)}íƒ€ (ì™„ì„± ${st.meCount}íšŒ / ì´ ë°©ë¬¸ ${st.count}íšŒ)`;
  }

  function renderCourseDetail(){
    if (!currentCourseId){
      return `
        <div class="card">
          <div class="muted">ì§€ë„ì—ì„œ ê³¨í”„ì¥(â›³)ì„ ëˆ„ë¥´ê±°ë‚˜ ëª©ë¡ì—ì„œ â€œì—´ê¸°â€ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
        </div>
      `;
    }

    const course = loadCourses().find(x => x.id === currentCourseId);
    if (!course) return "";

    const roundsObj = loadRounds();
    const rounds = (roundsObj[currentCourseId] || []);
    const visitCount = rounds.length;

    // list
    const roundsHtml = rounds.map(r => {
      const meTotal = getMeTotalFromRound(r);
      const meTxt = (meTotal !== null) ? ` Â· ë‚˜ ${meTotal}íƒ€` : "";
      const pnames = (r.players||[]).map(p=>p.name).filter(Boolean).slice(0,4).join(", ");
      return `
        <div class="item">
          <div class="row" style="justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:900;">ğŸ“… ${escapeHtml(r.date||"")} Â· â± ${escapeHtml(r.teeTime||"")}${meTxt}</div>
              <div class="small">${escapeHtml(pnames || "í”Œë ˆì´ì–´ ì—†ìŒ")}</div>
              ${r.comment ? `<div class="muted" style="margin-top:8px;">${escapeHtml(r.comment)}</div>` : ``}
            </div>
            <div class="row">
              <button class="btn tiny" data-edit-round="${escapeHtml(r.id)}">ìƒì„¸/ìˆ˜ì •</button>
              <button class="btn tiny danger" data-del-round="${escapeHtml(r.id)}">ì‚­ì œ</button>
            </div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="card soft">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:900; font-size:16px;">${escapeHtml(course.name)}</div>
            <div class="muted">${escapeHtml(course.region||"")} Â· ë°©ë¬¸ ${visitCount}</div>
            <div class="small" style="margin-top:6px;">${computeCourseStatsLine(currentCourseId)}</div>
            ${course.homepage ? `<div class="small" style="margin-top:6px;">í™ˆí˜ì´ì§€: <a href="${course.homepage}" target="_blank" rel="noopener" style="color:var(--accent2); font-weight:900;">ì—´ê¸°</a></div>` : ``}
          </div>
          <div class="row">
            <button class="btn tiny" id="btnPanToCourse">ì§€ë„</button>
          </div>
        </div>

        <hr class="sep">

        <div style="font-weight:900;">â• ë¼ìš´ë“œ ê¸°ë¡ ${editRoundId ? "(ìˆ˜ì • ëª¨ë“œ)" : ""}</div>

        <div class="row" style="margin-top:8px;">
          <div style="flex:1; min-width:160px;">
            <input id="roundDate" type="date" />
          </div>
          <div style="flex:1; min-width:160px;">
            <input id="roundTime" type="time" />
          </div>
          <div class="row" style="gap:8px;">
            <button class="btn tiny" id="btnAddPlayer">+ ë™ë°˜ì</button>
            <button class="btn tiny" id="btnResetPlayers">í”Œë ˆì´ì–´ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div style="margin-top:10px;">
          ${renderPlayersTable()}
        </div>

        <div style="margin-top:10px;">
          <textarea id="roundComment" placeholder="ì½”ë©˜íŠ¸(ì˜ˆ: ê·¸ë¦° ë¹ ë¦„ / ë°”ëŒ / í¼íŒ… / ìºë”” / ì½”ìŠ¤ ë‚œì´ë„)"></textarea>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnSaveRound">ì €ì¥</button>
          <button class="btn" id="btnClearRoundForm">ì´ˆê¸°í™”</button>
        </div>

        <hr class="sep">

        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div style="font-weight:900;">ğŸ“š ë¼ìš´ë“œ ê¸°ë¡</div>
            <div class="small">ì´ ${visitCount}íšŒ</div>
          </div>
        </div>

        <div style="display:grid; gap:10px; margin-top:10px;">
          ${roundsHtml || `<div class="muted">ì•„ì§ ë¼ìš´ë“œ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`}
        </div>
      </div>
    `;
  }

  /**********************
   * Render
   **********************/
  function render(){
    panel.innerHTML =
      `<div class="sticky-tools">
        ${renderChecklist()}
      </div>
      ${renderCoursesList()}
      ${renderAddCourse()}
      ${renderCourseDetail()}
      <div class="card">
        <div class="small">ì €ì¥: ì´ ë¸Œë¼ìš°ì €(localStorage). GitHub Pages + í™ˆí™”ë©´ ë°”ë¡œê°€ê¸°ë¡œ ì•±ì²˜ëŸ¼ ì‚¬ìš© ê°€ëŠ¥.</div>
      </div>`;

    bindChecklist();
    bindCourseList();
    bindAddCourse();
    bindCourseDetail();
  }

  /**********************
   * Bindings
   **********************/
  function bindChecklist(){
    const btn = document.getElementById("btnToggleChecklist");
    if (btn){
      btn.onclick = () => {
        prefs.checklistOpen = !prefs.checklistOpen;
        savePrefs(prefs);
        render();
      };
    }
    const btnRain = document.getElementById("btnRain");
    if (btnRain){
      btnRain.onclick = () => {
        prefs.rainyMode = !prefs.rainyMode;
        savePrefs(prefs);
        render();
      };
    }

    if (prefs.checklistOpen){
      panel.querySelectorAll("input[data-check]").forEach(chk=>{
        chk.onchange = () => {
          const id = chk.getAttribute("data-check");
          const list = loadChecklist();
          const idx = list.findIndex(x=>x.id===id);
          if (idx >= 0){
            list[idx].done = chk.checked;
            saveChecklist(list);
          }
        };
      });

      const resetBtn = document.getElementById("btnChecklistReset");
      if (resetBtn){
        resetBtn.onclick = () => {
          const list = loadChecklist().map(x=>({ ...x, done:false }));
          saveChecklist(list);
          render();
        };
      }
    }
  }

  function bindCourseList(){
    const sel = document.getElementById("tagFilter");
    if (sel){
      sel.onchange = () => {
        prefs.tagFilter = sel.value;
        savePrefs(prefs);
        render();
      };
    }

    panel.querySelectorAll("[data-open]").forEach(b=>{
      b.onclick = () => selectCourse(b.getAttribute("data-open"), true);
    });

    panel.querySelectorAll("[data-fav]").forEach(el=>{
      el.onclick = () => {
        const id = el.getAttribute("data-fav");
        const courses = loadCourses();
        const idx = courses.findIndex(x=>x.id===id);
        if (idx < 0) return;
        courses[idx].favorite = !courses[idx].favorite;
        saveCourses(courses);
        render();
      };
    });

    panel.querySelectorAll("[data-del-course]").forEach(b=>{
      b.onclick = () => {
        const id = b.getAttribute("data-del-course");
        if (!confirm("ì´ ê³¨í”„ì¥ì„ ì‚­ì œí• ê¹Œìš”? (ë¼ìš´ë“œ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œ)")) return;

        const courses = loadCourses().filter(x=>x.id!==id);
        saveCourses(courses);

        const rounds = loadRounds();
        delete rounds[id];
        saveRounds(rounds);

        currentCourseId = (currentCourseId === id) ? null : currentCourseId;

        render();
        rebuildMarkers();
      };
    });

    // markers should reflect course filter? keep markers always show all courses (practical)
    // if you want filter to also hide markers later, we can add it.
  }

  function bindAddCourse(){
    const btnPick = document.getElementById("btnPickCourse");
    if (btnPick){
      btnPick.onclick = () => {
        pickingCourseLocation = !pickingCourseLocation;
        pickedLatLng = null;
        render();
      };
    }

    const btnAdd = document.getElementById("btnAddCourse");
    if (btnAdd){
      btnAdd.onclick = () => {
        const name = (document.getElementById("addCourseName").value || "").trim();
        const region = (document.getElementById("addCourseRegion").value || "").trim();
        const homepage = (document.getElementById("addCourseHome").value || "").trim();

        if (!name) return alert("ê³¨í”„ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
        if (!pickedLatLng) return alert("â€˜ìœ„ì¹˜ ì°ê¸°â€™ í›„ ì§€ë„ì—ì„œ ê³¨í”„ì¥ ìœ„ì¹˜ë¥¼ íƒ­í•˜ì„¸ìš”.");

        const tags = [];
        TAGS.forEach(t=>{
          const el = document.getElementById(`addCourseTag-${t}`);
          if (el && el.checked) tags.push(t);
        });

        const courses = loadCourses();
        const c = {
          id: "g-" + cryptoRandomId(),
          name, region,
          lat: pickedLatLng.lat,
          lng: pickedLatLng.lng,
          homepage,
          favorite: false,
          tags: normalizeTags(tags)
        };
        courses.unshift(c);
        saveCourses(courses);

        pickingCourseLocation = false;
        pickedLatLng = null;

        render();
        rebuildMarkers();
      };
    }
  }

  function renderPlayersDraftBindings(){
    const body = document.getElementById("playersBody");
    if (!body) return;

    body.querySelectorAll("input[data-pname]").forEach(inp=>{
      inp.oninput = () => { playersDraft[+inp.dataset.pname].name = inp.value; };
    });
    body.querySelectorAll("input[data-hole]").forEach(inp=>{
      inp.oninput = () => {
        const [pi, hi] = inp.dataset.hole.split(":").map(n=>parseInt(n,10));
        playersDraft[pi].holes[hi] = inp.value;
        // totals update requires rerender table; keep light by not rerender every keystroke
        // but totals depend on values; simplest: do nothing (totals show after save)
        // however users expect instant totals. We'll do a small re-render debounce:
        schedulePlayersTableRefresh();
      };
    });
    body.querySelectorAll("button[data-pdel]").forEach(btn=>{
      btn.onclick = () => {
        const idx = +btn.dataset.pdel;
        playersDraft.splice(idx, 1);
        if (playersDraft.length === 0) playersDraft = [{ name:"ë‚˜", holes:Array(18).fill("") }];
        refreshPlayersTableNow();
      };
    });
  }

  let playersRefreshTimer = null;
  function schedulePlayersTableRefresh(){
    clearTimeout(playersRefreshTimer);
    playersRefreshTimer = setTimeout(refreshPlayersTableNow, 220);
  }
  function refreshPlayersTableNow(){
    const container = document.getElementById("playersTableContainer");
    if (!container) return;
    container.innerHTML = renderPlayersTable();
    renderPlayersDraftBindings();
  }

  function resetPlayersDraft(){
    playersDraft = [{ name:"ë‚˜", holes:Array(18).fill("") }];
    editRoundId = null;
  }

  function resetRoundFormUI(){
    editRoundId = null;
    const d = document.getElementById("roundDate");
    const t = document.getElementById("roundTime");
    const c = document.getElementById("roundComment");
    if (d) d.value = "";
    if (t) t.value = "";
    if (c) c.value = "";
    resetPlayersDraft();
    refreshPlayersTableNow();
  }

  function bindCourseDetail(){
    if (!currentCourseId) return;

    const course = loadCourses().find(x=>x.id===currentCourseId);
    if (!course) return;

    const btnPan = document.getElementById("btnPanToCourse");
    if (btnPan){
      btnPan.onclick = () => map.setView([course.lat, course.lng], 12, { animate:true });
    }

    // We rendered table inline; to allow dynamic refresh without rerender whole panel,
    // wrap table in a container and refresh.
    // But renderCourseDetail currently injects renderPlayersTable() directly.
    // We'll patch by replacing it post-render here:
    const detailCard = panel.querySelector(".card.soft");
    if (detailCard){
      // find the first holes-wrap parent by injecting container if absent
      // We'll just insert a container around existing table by re-rendering in place:
      const holesExisting = detailCard.querySelector(".holes-wrap")?.parentElement;
      if (holesExisting){
        // already there; nothing.
      }
    }

    // Replace table area with container for refresh (safe)
    // Find the first occurrence of holes-wrap and wrap it is complex. We'll do simple:
    // If container doesn't exist, create it right after the row inputs (we locate by id roundComment).
    const commentEl = document.getElementById("roundComment");
    if (commentEl){
      // Insert container BEFORE comment textarea if not present
      if (!document.getElementById("playersTableContainer")){
        const holder = document.createElement("div");
        holder.id = "playersTableContainer";
        holder.style.marginTop = "10px";
        // Place it above the comment textarea
        commentEl.parentElement.parentElement.insertBefore(holder, commentEl.parentElement);
      }
      refreshPlayersTableNow();
    }

    const addPlayer = document.getElementById("btnAddPlayer");
    if (addPlayer){
      addPlayer.onclick = () => {
        playersDraft.push({ name:"", holes:Array(18).fill("") });
        refreshPlayersTableNow();
      };
    }

    const resetPlayers = document.getElementById("btnResetPlayers");
    if (resetPlayers){
      resetPlayers.onclick = () => {
        resetPlayersDraft();
        refreshPlayersTableNow();
      };
    }

    const saveBtn = document.getElementById("btnSaveRound");
    if (saveBtn){
      saveBtn.onclick = () => {
        const date = (document.getElementById("roundDate").value || "").trim();
        const teeTime = (document.getElementById("roundTime").value || "").trim();
        const comment = (document.getElementById("roundComment").value || "").trim();

        if (!date) return alert("ë¼ìš´ë”© ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        if (!teeTime) return alert("í‹°ì˜¤í”„ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.");

        // Clean players: keep if name exists or any hole filled
        const cleaned = playersDraft
          .map(p => ({
            name: (p.name||"").trim(),
            holes: (p.holes||Array(18).fill("")).map(v => (v ?? "").toString().trim())
          }))
          .filter(p => p.name.length>0 || p.holes.some(v => v !== ""));

        if (!cleaned.length) return alert("í”Œë ˆì´ì–´ë¥¼ ìµœì†Œ 1ëª… ì…ë ¥í•˜ì„¸ìš”.");

        // ensure "ë‚˜" exists (if user removed)
        if (!cleaned.some(p => p.name === "ë‚˜")){
          cleaned.unshift({ name:"ë‚˜", holes:Array(18).fill("") });
        }

        const rounds = loadRounds();
        const list = rounds[currentCourseId] || [];

        const payload = {
          id: editRoundId || ("r-" + cryptoRandomId()),
          date, teeTime,
          players: cleaned,
          comment,
          // store courseId for overall stats convenience
          courseId: currentCourseId
        };

        if (editRoundId){
          const idx = list.findIndex(r=>r.id===editRoundId);
          if (idx >= 0) list[idx] = payload;
          else list.unshift(payload);
        }else{
          list.unshift(payload);
        }

        rounds[currentCourseId] = list;
        saveRounds(rounds);

        updateCourseMarker(course);
        editRoundId = null;

        render();
        // after render, reset form
        setTimeout(resetRoundFormUI, 0);
      };
    }

    const clearBtn = document.getElementById("btnClearRoundForm");
    if (clearBtn) clearBtn.onclick = () => resetRoundFormUI();

    // list actions
    panel.querySelectorAll("[data-del-round]").forEach(btn=>{
      btn.onclick = () => {
        const rid = btn.getAttribute("data-del-round");
        if (!confirm("ì´ ë¼ìš´ë“œ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;

        const rounds = loadRounds();
        const list = rounds[currentCourseId] || [];
        rounds[currentCourseId] = list.filter(r=>r.id!==rid);
        saveRounds(rounds);

        updateCourseMarker(course);
        render();
      };
    });

    panel.querySelectorAll("[data-edit-round]").forEach(btn=>{
      btn.onclick = () => {
        const rid = btn.getAttribute("data-edit-round");
        const rounds = loadRounds();
        const list = rounds[currentCourseId] || [];
        const r = list.find(x=>x.id===rid);
        if (!r) return;

        editRoundId = rid;
        document.getElementById("roundDate").value = r.date || "";
        document.getElementById("roundTime").value = r.teeTime || "";
        document.getElementById("roundComment").value = r.comment || "";

        playersDraft = (r.players && r.players.length)
          ? r.players.map(p => ({ name:p.name||"", holes:(p.holes||Array(18).fill("")).slice(0,18).concat(Array(18).fill("")).slice(0,18) }))
          : [{ name:"ë‚˜", holes:Array(18).fill("") }];

        // refresh table
        refreshPlayersTableNow();

        // scroll to top for edit convenience
        panel.scrollTo({ top: 0, behavior: "smooth" });
      };
    });
  }

  /**********************
   * Map click (pick location)
   **********************/
  map.on("click", (e)=>{
    if (!pickingCourseLocation) return;
    pickedLatLng = e.latlng;
    render();
  });

  /**********************
   * Init
   **********************/
  function init(){
    // migrate older keys if needed? (skip for simplicity)
    rebuildMarkers();
    render();
  }

  document.getElementById("btnResetAll").onclick = () => {
    if (!confirm("ì •ë§ ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ê³¨í”„ì¥/ë¼ìš´ë“œ/ì²´í¬ë¦¬ìŠ¤íŠ¸/ì„¤ì • ëª¨ë‘ ì‚­ì œ)")) return;
    localStorage.removeItem(LS_COURSES);
    localStorage.removeItem(LS_ROUNDS);
    localStorage.removeItem(LS_CHECK);
    localStorage.removeItem(LS_PREF);

    // reset in-memory
    prefs = { checklistOpen:false, rainyMode:false, tagFilter:"ì „ì²´", recentN:5 };
    currentCourseId = null;
    pickingCourseLocation = false;
    pickedLatLng = null;
    playersDraft = [{ name:"ë‚˜", holes:Array(18).fill("") }];
    editRoundId = null;

    init();
  };

  init();
</script>
</body>
</html>
